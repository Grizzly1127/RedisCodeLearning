# RDB持久化

## 简介

---
源码位置：rdb.c/rdb.h

**1. RDB持久化**
Redis是内存数据库，所有的数据都是存在内存中，这样就会存在一个问题，就是当服务进程退出，所有数据都将会丢失，所以Redis提供了两种数据持久化的机制，分别是RDB(Redis DataBase)和AOF(Append Only File)。这两种机制的区别将在后面介绍AOF持久化中介绍。  

RDB其实就是把数据以快照的形式保存在磁盘上。什么是快照呢，你可以理解成把当前时刻的数据拍成一张照片保存下来。  
RDB持久化是指在指定的时间间隔内将内存中的数据集快照写入磁盘。也是默认的持久化方式，这种方式是就是将内存中数据以快照的方式写入到二进制文件中，默认的文件名为`dump.rdb`。

**2. RDB持久化的方式**
RDB持久化有三种方式，分别是：SAVE、BGSAVE、根据配置定期执行。
①.SAVE触发
该命令会阻塞当前Redis服务器，执行save命令期间，Redis不能处理其他命令，直到RDB过程完成为止。
②.BGSAVE触发
执行该命令时，Redis会派生出一个子进程，然后由子进程负责创建 RDB 文件，父进程继续处理命令请求。
③.定期执行
定期执行的触发是由我们的配置文件来完成的。在redis.conf配置文件中，里面有如下配置，我们可以去设置：

* **save**：这里是用来配置触发 Redis的 RDB 持久化条件，也就是什么时候将内存中的数据保存到硬盘。比如"save m n"。表示m秒内数据集存在n次修改时，自动触发bgsave。
* **stop-writes-on-bgsave-error**：默认值为yes。当启用了RDB且最后一次后台保存数据失败，Redis是否停止接收数据。这会让用户意识到数据没有正确持久化到磁盘上，否则没有人会注意到灾难（disaster）发生了。如果Redis重启了，那么又可以重新开始接收数据了。
* **rdbcompression**：默认值是yes。对于存储到磁盘中的快照，可以设置是否进行压缩存储。
* **rdbchecksum**：默认值是yes。在存储快照后，我们还可以让redis使用CRC64算法来进行数据校验，但是这样做会增加大约10%的性能消耗，如果希望获取到最大的性能提升，可以关闭此功能。
* **dbfilename**：设置快照的文件名，默认是 dump.rdb。
* **dir**:设置快照文件的存放路径，这个配置项一定是个目录，而不能是文件名。

|命令|SAVE|BGSAVE|
|---|---|---|
|IO类型|同步|异步|
|阻塞状态|是|是（阻塞发生在fork）|
|复杂度|O(n)|O(n)|
|优点|不会消耗额外内存|不阻塞客户端命令|
|缺点|阻塞客户端命令|需要fork，消耗内存|

**3. RDB的优势和劣势**
**优势：**

* RDB文件紧凑，全量备份，非常适合用于进行备份和灾难恢复。
* 生成RDB文件的时候，redis主进程会fork()一个子进程来处理所有保存工作，主进程不需要进行任何磁盘IO操作。
* RDB 在恢复大数据集时的速度比 AOF 的恢复速度要快。

**劣势：**
RDB快照是一次全量备份，存储的是内存数据的二进制序列化形式，存储上非常紧凑。当进行快照持久化时，会开启一个子进程专门负责快照持久化，子进程会拥有父进程的内存数据，父进程修改内存子进程不会反应出来，所以在快照持久化期间修改的数据不会被保存，可能丢失数据。
